<!DOCTYPE html>
<html>
  <head>
    <title>Simulacion de nieve</title>
      <style>
      <style>
            html, body { margin: 0; padding: 0; overflow: hidden; }
            #info {
                position: absolute;
                width: 100%;
                text-align: center;
                color: #FFFFFF;
            }
        </style>
  </head>
  <body>

  
   <!--Librerias de graficacion-->
    <script src="js/three.min.js"></script>
    <script src='js/libs/dat.gui.min.js'></script>
    <script src="js/controls/OrbitControls.js"></script>
    
    <!--Librerias algebraicas para matrices-->
    <script src="https://unpkg.com/svd-js" type="application/javascript"></script>
    <script src="https://unpkg.com/lightmatrix/dist/lightmatrix.js"></script>
     
    <!--Librerias para la simulacion-->
    <script src="Set.js"></script>
    <script src="Escena.js"></script>
    <script src= "CrearEsferaParticulas.js"></script>
    <script src="OperacionesVectoresMatrices.js"></script>
    <script src="ParametrosFisicos.js"></script>
    <script src="Interpolacion.js"></script>
    <script src="Particula.js"></script>
    <script src="Fuerzas.js"></script>
    <script src="Grid.js"></script>
    <script src="Planos.js"></script>
    <script src="PlanosPrueba.js"></script>
    <script src="Simulacion.js"></script>
   <!-- <script src="main.js"></script>-->
    
    <script>
    //Creacion de atributos de la simulacion
    var frames_per_second = 30;
    var delta_t = 1e-3;

    // Parametros fisicos
    var E_0 = 1.4e5;            // Young's modulus
    var nu = 0.2;               // Poisson's ratio
    var xi = 10;                // Hardening coefficient
    var theta_c = 2.5e-2;       // Critical compression
    var theta_s = 7.5e-3;       // Critical stretch
    var alpha = 0.95;           // FLIP/PIC ratio

    var mu = 1.0; // static friction

    var num_particulas = 1e-3;

    n_func_init();
    n_func_derivative_init();

        
    var res_x = 30;
    var res_y = 30;
    var res_z = 30;
    var dim = new THREE.Vector3(res_x, res_y, res_z);
    var h = 5 / res_y;

    //Creacion de objetos    
    var grid = new Grid(res_x, res_y, res_z, h);
    var parametros = new ParametrosFisicos(E_0, nu, xi, theta_c, theta_s, alpha);
    var nievesim = new Simulacion(frames_per_second, delta_t, parametros);   
    nievesim.cargarGrid(grid);

    var mundoalmodelo = new THREE.Matrix4();
    mundoalmodelo = trasladarMat4(mundoalmodelo,new THREE.Vector3(grid.dim_x / 2, 0, grid.dim_z / 2));    
    var modeloalmundo = new THREE.Matrix4();
    modeloalmundo = trasladarMat4(modeloalmundo,new THREE.Vector3(-grid.dim_x / 2, 0, -grid.dim_z / 2));


    //Se crean las particulas de la simulacion
    var radio = Math.pow(3 * num_particulas / (16 * Math.PI), 1/3) * h;
    CrearEsferaParticulas(grid,num_particulas,radio);
        
    //Array que guarda las colisiones
    var objetos = new Array();
	
	init();
	animate();
    render();
		
	function init(){
        
        //Creacion de la escena 3D
        creacion();
        
        
        //Construccion de la caja que contendra la simulacion
        var mu = 0.2;
        var color_suelo = new THREE.Color(0x544F4F); //Color del suelo
        var origen = new THREE.Vector3(-1 * grid.dim_x/2,0, -1 * grid.dim_z/2);//(-2.5,0,-2.5)
        var eje_x = new THREE.Vector3(grid.dim_x,0,0);//(5,0,0)
        var eje_y = new THREE.Vector3(0,grid.dim_y,0);//(0,5,0)
        var eje_z = new THREE.Vector3(0,0,grid.dim_z);//(0,0,5)
        //Suelo
        var suelo = new Planos(origen,eje_x,eje_z,mu,modeloalmundo,mundoalmodelo,color_suelo);
        //Caras
        var color_caras = new THREE.Color(0xD7C3F3);
        var o_eje_x = sumaVec3(origen,eje_x);
        var o_eje_z = sumaVec3(origen,eje_z);
        var cara_1 = new Planos(origen,eje_x,eje_y,mu,modeloalmundo,mundoalmodelo,color_caras);//cara en -z
        var cara_2 = new Planos(origen,eje_z,eje_y,mu,modeloalmundo,mundoalmodelo,color_caras);//cara en -x
        var cara_3 = new Planos(o_eje_x,eje_y,eje_z,mu,modeloalmundo,mundoalmodelo,color_caras);//cara en x
        var cara_4 = new Planos(o_eje_z,eje_x,eje_y,mu,modeloalmundo,mundoalmodelo,color_caras);//cara en z

        //cargamos los objetos en el array 
        objetos.push(suelo);
        //objetos.push(cara_1);
        //objetos.push(cara_2);
        //objetos.push(cara_3);
        //objetos.push(cara_4);

        //Construccion de la cuña
        var color_cunia = new THREE.Color('skyblue');
        var esquina =  new THREE.Vector3(0,grid.dim_y/2,-grid.dim_z/2.5);//(0,2.5,-2)
        var borde_superior = new THREE.Vector3(0, 0, 0.8 * grid.dim_z);//(0,0,4)
        var borde1 = new THREE.Vector3(0.15*grid.dim_x, -0.15*grid.dim_y, 0);//(0.75,-0.75,0)
        var borde2 = new THREE.Vector3(-0.15*grid.dim_x, -0.15*grid.dim_y, 0);//(-0.75,-0.75,0)
        //var borde3 = new THREE.Vector3(0.75, 0.75, 0);
        var cunia_1 = new Planos(esquina,borde1,borde_superior,mu,modeloalmundo,mundoalmodelo,color_cunia);
        var cunia_2 = new Planos(esquina,borde_superior,borde2,mu,modeloalmundo,mundoalmodelo,color_cunia);
        
        //cargamos las cuñas al array 
        //objetos.push(cunia_1);
        //objetos.push(cunia_2);
        
        //Se cargan los metodo de la simulacion
        nievesim.cargarModeloalmundo(modeloalmundo);
        nievesim.cargarColisionObjeto(objetos);
        nievesim.dibujarContenido();  
        
        
        
        
        /*var mat = new THREE.Matrix3();
        mat.set(12,4,12,
                5,2,5,
                3,4,32);
        
        var rdet = determinateMat3(mat);
        
        console.log(rdet);
        
        console.log("det 2: ",mat.determinant());
        
        console.log(mat.elements);*/
        
        /*var p1 = new GridNode();
        var p2 = new GridNode();
        
        p1.index = new THREE.Vector3(1,2,3);        
        p2.index = new THREE.Vector3(3,2,3); 
        
        var n1=0;
        var n2=1;
        var n3=1;
        var r = new Map();
        r.set(Object.keys({p1,p2}));
        //r.set(Object.entries(p2));
        //r.add(n3);
        
        console.log("Tamaño: ",r.size);
        
        for (const value of r) {
            //var resp =value.posicion.x*2;  
            console.log(r); // logs 1, 2 and 3
        }*/
        
        /*var myArray = [p1, p2];
        var uniqueArray = myArray.filter((val, ind, arr) => arr.indexOf(val) === ind);
        console.log("Original Array = ",myArray);
        console.log("Array with unique values = ",uniqueArray);*/
        
    }    

	function render(){
      nievesim.eliminarObjetosEscena();
      nievesim.dibujarContenido();  
    }
        
    function animate() {
        requestAnimationFrame( animate );
        renderer.render( scene, camera );
        render();
	}
	
	
    </script>
  </body>
</html>